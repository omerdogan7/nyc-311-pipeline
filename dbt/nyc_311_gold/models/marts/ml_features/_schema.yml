version: 2

models:
  - name: volume_forecasting_features
    description: "Feature store for 311 complaint volume forecasting (Prophet-compatible)"
    
    columns:
      # Prophet Required
      - name: ds
        description: "Date for Prophet"
        tests:
          - unique
          - not_null
      
      - name: y
        description: "Target: total daily complaints"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 50000
      
      # Key Metrics
      - name: total_complaints
        tests:
          - not_null
      
      - name: closed_complaints
        tests:
          - dbt_utils.expression_is_true:
              expression: "<= total_complaints"
      
      - name: sla_compliance_rate
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      
      - name: avg_response_time_hours
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      
      # Data Quality
      - name: data_quality_tier
        tests:
          - not_null
          - accepted_values:
              values: ['HIGH', 'MEDIUM', 'LOW', 'UNKNOWN']
      
      - name: sla_quality_tier
        tests:
          - accepted_values:
              values: ['HIGH', 'MEDIUM', 'LOW']
      
      # Key Regressors
      - name: is_weekend
        tests:
          - accepted_values:
              values: [0, 1]
      
      - name: is_holiday
        tests:
          - accepted_values:
              values: [0, 1]
      
      - name: covid_period
        tests:
          - accepted_values:
              values: ['pre_covid', 'covid_peak', 'post_covid']

tests:
  - name: no_duplicate_dates
    sql: |
      SELECT ds, COUNT(*) 
      FROM {{ ref('volume_forecasting_features') }}
      GROUP BY ds
      HAVING COUNT(*) > 1
  
  - name: valid_sla_logic
    sql: |
      SELECT *
      FROM {{ ref('volume_forecasting_features') }}
      WHERE within_sla_count > total_valid_for_sla
         OR total_valid_for_sla > closed_complaints
  
  - name: no_negative_response_times
    sql: |
      SELECT *
      FROM {{ ref('volume_forecasting_features') }}
      WHERE avg_response_time_hours < 0
         OR median_response_time_hours < 0